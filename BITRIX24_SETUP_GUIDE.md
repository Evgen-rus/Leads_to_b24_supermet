# Инструкция по настройке отправки лидов в Битрикс24

## Что нужно получить от клиента

### 1. Обязательные данные от клиента

#### 1.1 Webhook URL для Битрикс24
- **Что это:** Специальный URL для доступа к API Битрикс24 клиента
- **Формат:** `https://[ПОРТАЛ].bitrix24.ru/rest/[USER_ID]/[WEBHOOK_KEY]/`
- **Пример:** `https://supermet.bitrix24.ru/rest/3900/bq745g4ngowz4z43/`

**Как клиент может получить Webhook URL:**
1. Зайти в свой Битрикс24
2. Перейти в Приложения → Разработчикам → Другое → Входящий вебхук
3. Создать новый вебхук с правами на CRM
4. Скопировать полученный URL

#### 1.2 Настройки лида
Следующие параметры нужны для корректного создания лидов:

**SOURCE_ID** - Источник лида
- **Что это:** ID источника, откуда пришел лид
- **Как узнать:** Используйте скрипт `bitrix24_fields.py` для получения списка
- **Пример:** `'106'` (LeadRecord)

**STATUS_ID** - Статус (этап) лида  
- **Что это:** ID этапа воронки, на который будет помещен лид
- **Как узнать:** Используйте скрипт `bitrix24_fields.py` для получения списка
- **Пример:** `'UC_LF7L5W'` (DMP - LEADRECORD)

**ASSIGNED_BY_ID** - Ответственный за лид
- **Что это:** ID пользователя, который будет назначен ответственным
- **Как узнать:** Используйте скрипт `bitrix24_fields.py` для получения списка пользователей
- **Пример:** `'20140'`

### 2. Дополнительные настройки (опционально)

#### 2.1 Формат названия лида
- **Текущий формат:** `LR_конк_ {phone}` где {phone} - номер телефона
- **Можно настроить:** Любой формат по желанию клиента

#### 2.2 Дополнительные поля
Если клиент хочет заполнять дополнительные поля лида, нужно узнать их ID через `bitrix24_fields.py`

## Как получить нужные ID полей

### Шаг 1: Настройка скрипта
1. Откройте файл `src/bitrix24_fields.py`
2. В функции `main()` измените `webhook_url` на URL клиента:
```python
webhook_url = "https://[ПОРТАЛ_КЛИЕНТА].bitrix24.ru/rest/[USER_ID]/[WEBHOOK_KEY]/"
```

### Шаг 2: Запуск скрипта
```bash
python src/bitrix24_fields.py
```

### Шаг 3: Анализ результатов
Скрипт выведет все доступные поля лида с их ID и описанием.

**Ищите следующие поля:**
- **SOURCE_ID** - в поле "Источник" 
- **STATUS_ID** - в поле "Стадия"
- **ASSIGNED_BY_ID** - нужно дополнительно запросить список пользователей

## Настройка в коде

### Обновление конфигурации
После получения всех данных обновите файл `src/bitrix24.py`:

```python
# В функции send_to_bitrix24() измените:
config = {
    'webhook_url': 'https://[КЛИЕНТ].bitrix24.ru/rest/[USER_ID]/[KEY]/crm.lead.add.json'
}

# И параметры лида:
lead_payload = {
    'fields': {
        'TITLE': f'LR_конк_ {phone}',  # Можно изменить формат
        'PHONE': [{'VALUE': phone, 'VALUE_TYPE': 'WORK'}],
        'SOURCE_ID': '[ID_ИСТОЧНИКА]',      # Заменить на ID от клиента
        'STATUS_ID': '[ID_СТАТУСА]',        # Заменить на ID от клиента  
        'ASSIGNED_BY_ID': '[ID_ПОЛЬЗОВАТЕЛЯ]' # Заменить на ID от клиента
    }
}
```

## Тестирование настройки

### 1. Тестовая отправка
Используйте файл `src/upload_leads.py` для тестовой отправки:
1. Создайте Excel файл с колонкой "Телефон" и тестовым номером
2. Запустите `python src/upload_leads.py`
3. Проверьте, что лид появился в Битрикс24 клиента

### 2. Проверка логов
Проверьте файл `logs/leads_to_b24.log` на наличие ошибок:
```bash
# Windows PowerShell
Get-Content logs\leads_to_b24.log -Tail 10
```

## Чек-лист для клиента

- [ ] Предоставлен Webhook URL
- [ ] Указан нужный SOURCE_ID (источник)
- [ ] Указан нужный STATUS_ID (этап воронки)  
- [ ] Указан нужный ASSIGNED_BY_ID (ответственный)
- [ ] Согласован формат названия лида
- [ ] Проведено тестирование
- [ ] Лиды корректно попадают в Битрикс24

## Возможные проблемы

### Ошибка 401 (Unauthorized)
- Проверьте правильность Webhook URL
- Убедитесь, что вебхук активен в Битрикс24

### Ошибка 400 (Bad Request)  
- Проверьте правильность ID полей (SOURCE_ID, STATUS_ID, ASSIGNED_BY_ID)
- Используйте `bitrix24_fields.py` для получения актуальных ID

### Лиды создаются, но с неправильными параметрами
- Проверьте соответствие ID полей
- Убедитесь, что указанный пользователь существует и активен

## Контакты для поддержки

При возникновении проблем обращайтесь к разработчику с:
1. Скриншотом ошибки из логов
2. Webhook URL (можно скрыть ключ)
3. Используемыми ID полей 